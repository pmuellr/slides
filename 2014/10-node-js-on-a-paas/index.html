<!DOCTYPE html>
<html>
  <head>
    <title>node.js on a PaaS</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="icon"       href="../../images/js.png">
    <link rel="stylesheet" href="remark-custom.css">
  </head>
  <body>
    <textarea id="source" cols="100" rows="40" style="display: none;">

# node.js on a PaaS

### the awesome and the wonky

&nbsp;

Patrick Mueller
-
[`@pmuellr`](https://twitter.com/pmuellr)
-
[`muellerware.org`](http://muellerware.org)

developer advocate for IBM's [Bluemix](http://bluemix.net) PaaS

.smaller[.smaller[
<http://pmuellr.github.io/slides/2014/10-node-js-on-a-paas>
<br>
<http://pmuellr.github.io/slides/> (all slides)
]]

<div class="toolBar">
  <div class="navHelp" title="use the cursor keys to navigate, 'n' to toggle nav buttons, 's' to toggle control panel">
    <img class="button-1st"  height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_171_fast_backward.png">
    <img class="button-prev" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_172_rewind.png">
    <img class="button-next" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_176_forward.png">
  </div>
  <div>&nbsp;&nbsp;</div>
  <div class="controlPanel" title="'s' to toggle control panel">
    <img class="button-clicker" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_046_router.png"   title="use clicker">
    <img class="button-hd"      height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_391_video_hd.png" title="toggle HD">
  </div>
</div>

---

layout: true

<div class="page-icon">
<span class="smaller"><span class="smaller">
<tt>node.js on a PaaS</tt>
</span></span>
<!--
  <img height=24 src="../../glyphicons_free/glyphicons/png/glyphicons_046_router.png">
  &nbsp;
  <img height=24 src="../../images/js.png">
  &nbsp;
-->
</div>

{{content}}

<div class="toolBar">
  <div class="navHelp" title="use the cursor keys to navigate, 'n' to toggle nav buttons, 's' to toggle control panel">
    <img class="button-1st"  height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_171_fast_backward.png">
    <img class="button-prev" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_172_rewind.png">
    <img class="button-next" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_176_forward.png">
  </div>
  <div>&nbsp;&nbsp;</div>
  <div class="controlPanel" title="'s' to toggle control panel">
    <img class="button-clicker" height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_046_router.png"   title="use clicker">
    <img class="button-hd"      height=16 src="../../glyphicons_free/glyphicons/png/glyphicons_391_video_hd.png" title="toggle HD">
  </div>
</div>

---

### wat - node.js on a PaaS

* you know what node.js is

* PaaS &#x279C; Platform as a Service

* examples:
  * [Heroku](https://www.heroku.com/home)
  * [Nodejitsu](https://www.nodejitsu.com/)
  * [Cloud Foundry](http://cloudfoundry.org/index.html)
  * [OpenShift](https://developers.openshift.com/)
  * [many](http://seroter.wordpress.com/2013/07/29/where-the-heck-do-i-host-my-node-js-app/)
    [more!](https://github.com/joyent/node/wiki/node-hosting#managed)

---

### PaaS fundamentals

* you provide the application

* OS provided for you (Linux)

* configure:
  * hosted services
  * number of instances running
  * RAM per instance
  * ephemeral disk per instance

---

### PaaS usage scenarios

* special focus on web servers, typically with:

  * one open HTTP port open when app starts
  * HTTPS support
  * custom domains
  * WebSocket support

* or anything - arbitrary compute

---

### PaaS app development methodology

The Twelve Factor App - http://12factor.net/

*patterns for building apps on the cloud*

<table width="100%">
<tr><td>1. Codebase                 <td>7. Port binding
<tr><td>2. Dependencies             <td>8. Concurrency
<tr><td>3. Config                   <td>9. Disposability
<tr><td>4. Backing Services         <td>10. Dev/prod parity
<tr><td>5. Build, release, run      <td>11. Logs
<tr><td>6. Processes                <td>12. Admin processes
</table>

---

### PaaS app development methodology

* **Codebase** - One codebase tracked in revision control, many deploys
* **Dependencies** - Explicitly declare and isolate dependencies
* **Config** - Store config in the environment
* **Backing Services** - Treat backing services as attached resources
* **Build, release, run** - Strictly separate build and run stages
* **Processes** - Execute the app as one or more stateless processes

---

### PaaS app development methodology

* **Port binding** - Export services via port binding
* **Concurrency** - Scale out via the process model
* **Disposability** - Maximize robustness with fast startup and graceful shutdown
* **Dev/prod parity** - Keep development, staging, and production as similar as possible
* **Logs** - Treat logs as event streams
* **Admin processes** - Run admin/management tasks as one-off processes

---

### let's deploy an app to Cloud Foundry

<pre><code>$ <span style="color:#090">git clone https://github.com/pmuellr/cf-node-hello.git</span>
$ <span style="color:#090">cd cf-node-hello</span>
$ <span style="color:#090">cf push</span>
Using manifest file .../manifest.yml
...
Installing IBM SDK for Node.js from admin cache
...
Installing dependencies
...
Uploading droplet (8.0M)
...
App started
...
urls: cf-node-hello-pjm.mybluemix.net
$ <span style="color:#090">curl https://cf-node-hello-pjm.mybluemix.net</span>
Hello World
</code></pre>

---

### PaaS tools

* web dashboard

* command-line tooling
  * Heroku toolbelt - [`heroku`](https://toolbelt.heroku.com/)
  * Cloud Foundry - [`cf`](http://docs.cloudfoundry.org/devguide/installcf/)

* typically will be using both web and cli

---

### adapting your app

* configuration provided via environment variables

* `process.env` is your new best friend

* using Heroku's MongoLab add-on service:

```
process.env.PORT         // port to bind server to

process.env.MONGOLAB_URL // MongoLab db URL
   // mongodb://[user]:[pass]@[host]:[port]/[path]
```

---

### adapting your app - Cloud Foundry

* `PORT` - env var set to port to bind server to

* `VCAP_SERVICES` - JSON string containing structured service info

* `VCAP_APPLICATION` - JSON string containing other environmental info
  * url(s) to server
  * ip address of server
  * start time
  * etc

---

### adapting your app - Cloud Foundry

VCAP_SERVICES will look like this, but with even more data:

```js
{
  "mongodb-2.2": [
    {
      "name": "mongodb",
      "label": "mongodb-2.2",
      "credentials": {
          "url": "mongodb://..."
      }
    }
  ]
}
```

---

### adapting your app - Cloud Foundry

use the [cfenv package](https://www.npmjs.org/package/cfenv) to programmatically
introspect over `VCAP_SERVICES` and `VCAP_APPLICATION`

instead of:

```js
services = JSON.parse(process.env.VCAP_SERVICES)
mongoURL = services["mongodb-2.2"][0].credentials.url
```

use this:

```js
cfenv = require("cfenv")
appEnv = cfenv.getAppEnv()
mongoURL = appEnv.getServiceURL("mongodb")
```

---

### using hosted services

* add service to your app via:
  * command-line tool
  * web dashboard
  * roll your own access any 3rd service however you can

* services exposed to app via environment variables
  * Heroku's `MONGOLAB_URL` env var
  * inside of Cloud Foundry's `VCAP_SERVICES` env var

---

### using hosted services

Heroku:

<pre><code>$ <span style="color:#090">heroku addons:add mongolab</span>
</code></pre>

Cloud Foundry:

<pre><code>$ <span style="color:#090">cf create-service mongolab sandbox my-mongo-db
</code></pre>

---

### scaling

By default, PaaS will run one instance of your app.  Want more?

Heroku:

<pre><code>$ <span style="color:#090">heroku ps:scale web=42</span>
</code></pre>

Cloud Foundry:

<pre><code>$ <span style="color:#090">cf scale my-app -i 42
</code></pre>

---

### auto-scaling


---

class: center, middle

# the wonky

### and how to de-wonk-ify

---

### core issues

* can't configure base operating system

* often no ssh

* stdout/err via syslog

* ephemeral file system

---

### debugging

node-inspector difficult to run

* wants two ports open
* PaaS typically provides one

&#x279C;

use a proxy splitter

* [cf-node-debug](https://www.npmjs.org/package/cf-node-debug)


---

### other diagnostic tools

* https://devcenter.heroku.com/articles/strongloop
* New Relic

---

### diagnosing startup problems

* app runs fine on your laptop
* fails when run on PaaS

&#x279C;

* most errors here are in startup
* add LOTS of logging / run in verbose mode

---

### private packages

if the PaaS runs `npm install` for you, how do can you access private packages

&#x279C;

* manage them separately from the rest of your packages
* see [pmuellr/bluemix-private-packages](https://github.com/pmuellr/bluemix-private-packages)
  for an example project structure

---

### logging

* typically get last XX lines of your stdout/err
* but easy hook-ups to logging services:
  * [Loggly]()
  * [PaperTrails]()
  * [splunk>storm]()

---

### dependency versions

```js
//!snippet: wildcard-dependency.js
```

What's wrong with this `package.json` file?


---

### dependency versions

```js
//!snippet: wildcard-dependency.js
```

Guess what happened the day
[express 4.0 was released](https://github.com/strongloop/express/blob/master/History.md#400--2014-04-09)?

* removed from express:
  * properties on `express`, `req`, `res`
  * all bundled middleware except static

---

### dependency versions

Lesson: lock down your dependencies

do one of these:

* version your node_modules
* use [npm shrinkwrap](https://www.npmjs.org/doc/cli/npm-shrinkwrap.html)

---

class: center, middle

# `fin`


    </textarea>
    <script src="../../remark/0.6.4/remark.min.js"></script>
    <script src="../../lib/jquery/2.1.1/jquery.min.js"></script>
    <script src="snippets.js"></script>
    <script src="remark-custom.js"></script>
  </body>
</html>
